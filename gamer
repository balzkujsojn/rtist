repeat task.wait() until game:IsLoaded()
local Players = game:GetService("Players")
repeat task.wait() until Players.LocalPlayer
local player = Players.LocalPlayer

local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")
local TweenService = game:GetService("TweenService")
local TeleportService = game:GetService("TeleportService")

local CONFIG = {
    FIRE_RATE = 0.05,
    TOOL_NAME = "Equinox Cannon",
    REMOTE_NAME = "RemoteFunction"
}

-- Ignored enemies list (these are our allies now)
local IGNORE_ENEMIES = {
    ["Champion of the Equinox"] = true,
    ["Fiscus"] = true,
    ["Shellshock"] = true,
    ["The Last Spirit of Christmas"] = true,
    ["Present Mimic"] = true
}

-- Priority enemies (Penguin Copter first, then Comet boss)
local PRIORITY_ENEMIES = {
    ["Penguin Copter"] = true,  -- Highest priority
    ["Comet, the Mechanical Vengeance"] = true  -- Second priority
}

-- Place IDs
local SPECIFIC_PLACE_ID = 112802237735950
local AUTOTELEPORT_PLACE_ID = 8811271345

-- Platform position
local PLATFORM_POSITION = Vector3.new(-251, 130, 3783)
local PLATFORM_SIZE = Vector3.new(20, 5, 20)  -- 20x20 platform with 5 studs height

-- State management
local State = {
    isRunning = true,
    specialMode = false,
    lastFireTime = 0,
    currentTarget = nil,
    chargeValue = 100,
    bossHasSpawned = false,
    bossCompleted = false,
    playerAlive = true,
    skipSaid = false,
    skipAllSaid = false,
    teleported = false,
    rewardCollected = false,
    rewardPresentSpawned = false,
    rewardTaken = false,
    autoTeleportTriggered = false,
    shootingEnabled = true,
    shootingErrors = 0,
    maxShootingErrors = 10,
    platformCreated = false,
    dungeonTeleportAttempts = 0,
    maxDungeonAttempts = 3,
    bossDefeatedTime = 0,
    waitingForReward = false,
    lastToolEquipTime = 0,
    toolEquipCooldown = 2
}

local cache = {
    workspaceChildren = {},
    lastWorkspaceUpdate = 0,
    workspaceUpdateInterval = 0.5,
    lastPriorityCheck = 0
}

-- Helper functions
local function chatMessage(str)
    if type(str) ~= "string" then str = tostring(str) end
    
    if TextChatService.ChatVersion == Enum.ChatVersion.LegacyChatService then
        local events = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
        if events then
            local remote = events:FindFirstChild("SayMessageRequest")
            if remote then
                task.spawn(function()
                    pcall(remote.FireServer, remote, str, "All")
                end)
            end
        end
    else
        local channel = TextChatService:FindFirstChild("TextChannels")
        if channel then
            channel = channel:FindFirstChild("RBXGeneral")
            if channel and channel:IsA("TextChannel") then
                task.spawn(function()
                    pcall(channel.SendAsync, channel, str)
                end)
            end
        end
    end
end

local function sendSkipCommands()
    if game.PlaceId ~= SPECIFIC_PLACE_ID then return end
    if State.skipAllSaid then return end
    
    task.spawn(function()
        task.wait(0.5)
        chatMessage("/skipall")
        State.skipAllSaid = true
    end)
end

local function createPlatform()
    if State.platformCreated then return end
    
    local platform = Instance.new("Part")
    platform.Name = "AutoFarmPlatform"
    platform.Size = PLATFORM_SIZE
    platform.Position = PLATFORM_POSITION + Vector3.new(0, PLATFORM_SIZE.Y/2, 0)
    platform.Anchored = true
    platform.CanCollide = true
    platform.Transparency = 0.7
    platform.Color = Color3.fromRGB(0, 170, 255)
    platform.Material = Enum.Material.Neon
    
    local surfaceGui = Instance.new("SurfaceGui", platform)
    surfaceGui.Face = Enum.NormalId.Top
    surfaceGui.AlwaysOnTop = true
    
    local textLabel = Instance.new("TextLabel", surfaceGui)
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = "AutoFarm Platform"
    textLabel.TextColor3 = Color3.new(1, 1, 1)
    textLabel.TextScaled = true
    
    platform.Parent = workspace
    
    State.platformCreated = true
end

local function teleportToPlatform()
    if State.teleported then return end
    
    local char = player.Character
    if not char then return end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    -- Create platform first
    if not State.platformCreated then
        createPlatform()
    end
    
    -- Teleport to platform
    State.teleported = true
    
    local tweenInfo = TweenInfo.new(1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local targetCFrame = CFrame.new(PLATFORM_POSITION + Vector3.new(0, 5, 0))
    local tween = TweenService:Create(hrp, tweenInfo, {CFrame = targetCFrame})
    tween:Play()
end

local function isPlayerAlive()
    if not player.Character then return false end
    
    local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return false end
    
    return humanoid.Health > 0
end

local function checkAutoTeleport()
    if State.autoTeleportTriggered then
        return false
    end
    
    if game.PlaceId == AUTOTELEPORT_PLACE_ID then
        State.autoTeleportTriggered = true
        return true
    end
    
    return false
end

local function getTargetPart(model)
    local enemyName = model.Name
    
    -- Special handling for Comet boss - look for Body meshpart in MainBody
    if enemyName == "Comet, the Mechanical Vengeance" then
        local mainBody = model:FindFirstChild("MainBody")
        if mainBody then
            local bodyPart = mainBody:FindFirstChild("Body")
            if bodyPart and bodyPart:IsA("BasePart") then
                return bodyPart
            end
        end
        
        -- Fallback to Torso if Body not found
        local torso = model:FindFirstChild("Torso")
        if torso then
            return torso
        end
    end
    
    -- Default part search for other enemies
    local possibleParts = {
        "HumanoidRootPart",
        "Head",
        "Torso", 
        "UpperTorso",
        "LowerTorso",
        "Chest",
        "Body"
    }
    
    for _, partName in ipairs(possibleParts) do
        local part = model:FindFirstChild(partName)
        if part and part:IsA("BasePart") then
            return part
        end
    end
    
    for _, child in ipairs(model:GetChildren()) do
        if child:IsA("BasePart") then
            return child
        end
    end
    
    return nil
end

local function findEnemies()
    if not State.playerAlive or not State.shootingEnabled then 
        return {}
    end
    
    local now = tick()
    
    if now - cache.lastWorkspaceUpdate > cache.workspaceUpdateInterval then
        cache.workspaceChildren = workspace:GetChildren()
        cache.lastWorkspaceUpdate = now
    end
    
    local enemies = {}
    local priorityEnemies = {}
    
    for _, model in ipairs(cache.workspaceChildren) do
        if model:IsA("Model") and model.Parent == workspace then
            -- Skip ignored enemies (our allies)
            if IGNORE_ENEMIES[model.Name] then
                continue
            end
            
            local humanoid = model:FindFirstChildOfClass("Humanoid")
            
            if humanoid and humanoid.Health > 0 then
                local isPlayerCharacter = false
                for _, plr in ipairs(Players:GetPlayers()) do
                    if plr.Character == model then
                        isPlayerCharacter = true
                        break
                    end
                end
                
                if not isPlayerCharacter then
                    local targetPart = getTargetPart(model)
                    if targetPart then
                        local enemyData = {
                            Model = model,
                            Humanoid = humanoid,
                            TargetPart = targetPart,
                            Position = targetPart.Position,
                            Name = model.Name,
                            IsPriority = PRIORITY_ENEMIES[model.Name] == true,
                            LastSeen = now,
                            IsPenguinCopter = model.Name == "Penguin Copter",
                            IsComet = model.Name == "Comet, the Mechanical Vengeance"
                        }
                        
                        if model.Name == "Comet, the Mechanical Vengeance" then
                            State.bossHasSpawned = true
                        end
                        
                        if enemyData.IsPriority then
                            table.insert(priorityEnemies, enemyData)
                        else
                            table.insert(enemies, enemyData)
                        end
                    end
                end
            end
        end
    end
    
    -- Sort priority enemies: Penguin Copter first, then Comet
    if #priorityEnemies > 0 then
        table.sort(priorityEnemies, function(a, b)
            if a.IsPenguinCopter and not b.IsPenguinCopter then
                return true
            elseif not a.IsPenguinCopter and b.IsPenguinCopter then
                return false
            elseif a.IsComet and not b.IsComet then
                return true
            else
                return false
            end
        end)
        return priorityEnemies
    end
    
    return enemies
end

local function selectTarget()
    if not State.playerAlive or not State.shootingEnabled then 
        return nil
    end
    
    local enemies = findEnemies()
    
    if #enemies == 0 then
        return nil
    end
    
    if State.currentTarget then
        local targetModel = State.currentTarget.Model
        if targetModel and targetModel.Parent then
            local humanoid = targetModel:FindFirstChildOfClass("Humanoid")
            if humanoid and humanoid.Health > 0 then
                return State.currentTarget
            end
        end
    end
    
    local character = player.Character
    if not character then 
        return enemies[1] 
    end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then 
        return enemies[1] 
    end
    
    local playerPos = humanoidRootPart.Position
    local closestEnemy = enemies[1]
    local closestDistance = math.huge
    
    for _, enemy in ipairs(enemies) do
        local distance = (enemy.Position - playerPos).Magnitude
        if distance < closestDistance then
            closestDistance = distance
            closestEnemy = enemy
        end
    end
    
    return closestEnemy
end

local function getValidTool()
    if not State.playerAlive or not State.shootingEnabled then 
        return nil 
    end
    
    local character = player.Character
    if not character then 
        return nil 
    end
    
    local tool = character:FindFirstChild(CONFIG.TOOL_NAME)
    if not tool then 
        return nil 
    end
    
    local remote = tool:FindFirstChild(CONFIG.REMOTE_NAME)
    local handle = tool:FindFirstChild("Handle")
    
    if remote and handle and remote:IsA("RemoteFunction") then
        return {Tool = tool, Remote = remote, Handle = handle}
    end
    
    return nil
end

local function equipTool()
    local now = tick()
    
    if not State.playerAlive then 
        task.wait(0.5)
        return equipTool()
    end
    
    if now - State.lastToolEquipTime < State.toolEquipCooldown then
        return false
    end
    
    local character = player.Character
    if not character then 
        task.wait(0.5)
        return equipTool()
    end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then 
        task.wait(0.5)
        return equipTool()
    end
    
    local tool = character:FindFirstChild(CONFIG.TOOL_NAME)
    if tool then
        humanoid:EquipTool(tool)
        State.lastToolEquipTime = now
        return true
    end
    
    local backpack = player:FindFirstChild("Backpack")
    if backpack then
        tool = backpack:FindFirstChild(CONFIG.TOOL_NAME)
        if tool then
            tool.Parent = character
            task.wait(0.1)
            humanoid:EquipTool(tool)
            State.lastToolEquipTime = now
            return true
        end
    end
    
    return false
end

local function attemptFire()
    if not State.isRunning or State.specialMode or State.bossCompleted then 
        return 
    end
    if not State.playerAlive or not State.shootingEnabled then 
        return 
    end
    
    local success, targetResult = pcall(function()
        State.currentTarget = selectTarget()
        return State.currentTarget
    end)
    
    if not success then
        State.shootingErrors = State.shootingErrors + 1
        if State.shootingErrors > State.maxShootingErrors then
            State.shootingEnabled = false
            task.wait(5)
            State.shootingEnabled = true
            State.shootingErrors = 0
        end
        return
    end
    
    if not targetResult then
        return
    end
    
    local toolData
    local toolSuccess, toolResult = pcall(function()
        toolData = getValidTool()
        return toolData
    end)
    
    if not toolSuccess then
        State.shootingErrors = State.shootingErrors + 1
        return
    end
    
    if not toolResult then 
        local equipSuccess, equipResult = pcall(function()
            return equipTool()
        end)
        
        if not equipSuccess then
            State.shootingErrors = State.shootingErrors + 1
            return
        end
        
        if not equipResult then 
            return 
        end
        
        local toolRetrySuccess, toolRetryResult = pcall(function()
            toolData = getValidTool()
            return toolData
        end)
        
        if not toolRetrySuccess or not toolRetryResult then 
            return 
        end
        
        toolData = toolRetryResult
    end
    
    local now = tick()
    if now - State.lastFireTime < CONFIG.FIRE_RATE then 
        return 
    end
    
    State.lastFireTime = now
    
    local targetPart = targetResult.TargetPart
    if not targetPart then
        return
    end
    
    local targetPos = targetPart.Position
    
    -- Add random offset for Penguin Copter and Comet boss to ensure hits register
    if targetResult.Name == "Penguin Copter" or targetResult.Name == "Comet, the Mechanical Vengeance" then
        -- Add random offset (3-4 studs) in all directions
        local randomOffset = Vector3.new(
            math.random(3, 4) * (math.random() > 0.5 and 1 or -1),
            math.random(3, 4) * (math.random() > 0.5 and 1 or -1),
            math.random(3, 4) * (math.random() > 0.5 and 1 or -1)
        )
        targetPos = targetPos + randomOffset
    end
    
    local camera = workspace.CurrentCamera
    if not camera then 
        return 
    end
    
    local cameraPosition = camera.CFrame.Position
    local direction = (targetPos - cameraPosition).Unit
    
    local startPos = targetPos - (direction * 5)
    local endPos = targetPos
    
    local fireSuccess = pcall(function()
        toolData.Remote:InvokeServer("fire", {startPos, endPos, State.chargeValue})
    end)
    
    if not fireSuccess then
        State.shootingErrors = State.shootingErrors + 1
        
        if State.shootingErrors > State.maxShootingErrors then
            State.shootingEnabled = false
            task.wait(3)
            State.shootingEnabled = true
            State.shootingErrors = 0
        end
    else
        State.shootingErrors = 0
    end
end

local function equipArcticCore()
    local character = player.Character
    if not character then return false end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return false end
    
    -- First unequip Equinox Cannon if equipped
    local cannon = character:FindFirstChild(CONFIG.TOOL_NAME)
    if cannon then
        cannon.Parent = player.Backpack
    end
    
    task.wait(0.5)
    
    -- Check if Arctic Core is in character
    local arcticCore = character:FindFirstChild("Arctic Core")
    if not arcticCore then
        -- Check backpack
        local backpack = player:FindFirstChild("Backpack")
        if backpack then
            arcticCore = backpack:FindFirstChild("Arctic Core")
            if arcticCore then
                arcticCore.Parent = character
                task.wait(0.2)
            end
        end
    end
    
    if arcticCore then
        humanoid:EquipTool(arcticCore)
        task.wait(0.5)
        return true
    end
    
    return false
end

local function checkBossDead()
    -- Check if Comet is completely gone from workspace (not just dead, but removed)
    local comet = workspace:FindFirstChild("Comet, the Mechanical Vengeance")
    
    if not comet then
        -- Comet has been removed from workspace (completely dead)
        State.bossHasSpawned = false
        return true
    end
    
    -- Comet still exists, check if it's alive
    local humanoid = comet:FindFirstChildOfClass("Humanoid")
    if humanoid and humanoid.Health <= 0 then
        -- Comet is dead but still in workspace (might be in death animation)
        return true
    end
    
    return false
end

local function anyEnemiesLeft()
    local enemies = findEnemies()
    return #enemies > 0
end

local function checkRewardPresent()
    local present = workspace:FindFirstChild("RewardPresent")
    
    if present then
        State.rewardPresentSpawned = true
        
        -- Check if present has been taken (meshpart "Present" exists)
        local mesh = present:FindFirstChild("Present")
        if mesh and mesh:IsA("MeshPart") then
            return "exists"
        else
            State.rewardTaken = true
            return "taken"
        end
    else
        if State.rewardPresentSpawned and not State.rewardTaken then
            State.rewardTaken = true
            return "taken"
        end
        return "not_found"
    end
end

local function collectReward()
    local present = workspace:FindFirstChild("RewardPresent")
    if not present then return false end
    
    local mesh = present:FindFirstChild("Present")
    if not mesh or not mesh:IsA("MeshPart") then return false end
    
    local char = player.Character
    if not char then return false end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end
    
    -- Wait 5 seconds before teleporting to reward
    task.wait(5)
    
    -- Teleport to the present meshpart
    local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local targetCFrame = CFrame.new(mesh.Position + Vector3.new(0, 2, 0))
    local tween = TweenService:Create(hrp, tweenInfo, {CFrame = targetCFrame})
    tween:Play()
    
    return true
end

local function createPartyAndJoin()
    -- First create the party
    local createSuccess = pcall(function()
        local args = {
            [1] = "createParty",
            [2] = {
                ["settings"] = {
                    ["Visual"] = true,
                    ["FriendsOnly"] = false,
                    ["TormentMode"] = false
                },
                ["subplace"] = "ArcticZone"
            }
        }
        
        local partyRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("PartySystem"):WaitForChild("PartyFunction")
        partyRemote:InvokeServer(unpack(args))
        return true
    end)
    
    if not createSuccess then
        return false
    end
    
    task.wait(2)
    
    -- Then join the subplace
    local joinSuccess = pcall(function()
        local args = {
            [1] = "joinSubplace",
            [2] = {}
        }
        
        local partyRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("PartySystem"):WaitForChild("PartyFunction")
        partyRemote:InvokeServer(unpack(args))
        return true
    end)
    
    return joinSuccess
end

local function attemptArcticTeleport()
    State.bossCompleted = true
    State.specialMode = true
    State.isRunning = false
    State.shootingEnabled = false
    
    -- Unequip cannon first
    local character = player.Character
    if character then
        local cannon = character:FindFirstChild(CONFIG.TOOL_NAME)
        if cannon then
            cannon.Parent = player.Backpack
        end
    end
    
    task.wait(1)
    
    -- Equip Arctic Core
    local equipped = equipArcticCore()
    if not equipped then
        -- If Arctic Core not found, try to teleport anyway
        print("Arctic Core not found, attempting teleport anyway...")
    end
    
    task.wait(2)
    
    -- Try to teleport to dungeon
    local success = false
    for attempt = 1, State.maxDungeonAttempts do
        State.dungeonTeleportAttempts = attempt
        
        success = createPartyAndJoin()
        
        if success then
            break
        end
        
        if attempt < State.maxDungeonAttempts then
            task.wait(3)
        end
    end
    
    return success
end

local function handleDungeonTeleport()
    local success = attemptArcticTeleport()
    
    if not success then
        State.bossCompleted = false
        State.specialMode = false
        State.isRunning = true
        State.shootingEnabled = true
    end
end

local function farmingLoop()
    local lastBossCheck = 0
    local bossCheckInterval = 2
    local lastRewardCheck = 0
    local rewardCheckInterval = 1
    
    while State.isRunning and not State.bossCompleted do
        local now = tick()
        
        State.playerAlive = isPlayerAlive()
        
        if State.playerAlive then
            if checkAutoTeleport() then
                State.bossCompleted = true
                State.specialMode = true
                State.isRunning = false
                State.shootingEnabled = false
                task.wait(2)
                
                -- Equip Arctic Core first
                local equipped = equipArcticCore()
                if not equipped then
                    State.bossCompleted = false
                    State.specialMode = false
                    State.isRunning = true
                    State.shootingEnabled = true
                    State.autoTeleportTriggered = false
                    continue
                end
                
                task.wait(1)
                
                -- Create party and join directly
                local success = createPartyAndJoin()
                
                if not success then
                    State.bossCompleted = false
                    State.specialMode = false
                    State.isRunning = true
                    State.shootingEnabled = true
                    State.autoTeleportTriggered = false
                end
                break
            end
            
            if now - lastBossCheck > bossCheckInterval then
                local bossDead = checkBossDead()
                
                if bossDead and State.bossHasSpawned and not State.bossCompleted then
                    -- Boss is dead, continue shooting other enemies
                    State.bossHasSpawned = false
                    
                    -- Check if there are still enemies left
                    if not anyEnemiesLeft() then
                        -- No enemies left, start checking for reward
                        State.waitingForReward = true
                    end
                end
                
                lastBossCheck = now
            end
            
            if State.waitingForReward then
                -- Check for reward present
                if now - lastRewardCheck > rewardCheckInterval then
                    local rewardStatus = checkRewardPresent()
                    
                    if rewardStatus == "exists" and not State.rewardTaken then
                        collectReward()
                    elseif rewardStatus == "taken" then
                        State.waitingForReward = false
                        handleDungeonTeleport()
                        break
                    end
                    
                    lastRewardCheck = now
                end
            else
                -- Normal farming - continue shooting all enemies (including after boss death)
                attemptFire()
            end
        else
            State.currentTarget = nil
        end
        
        RunService.Heartbeat:Wait()
    end
end

local function onCharacterAdded(character)
    task.wait(2)
    
    if game.PlaceId == SPECIFIC_PLACE_ID then
        -- Send skip command
        if not State.skipAllSaid then
            sendSkipCommands()
        end
        
        -- Teleport to platform after skip command
        task.wait(1)
        if not State.teleported then
            teleportToPlatform()
        end
    end
    
    if State.isRunning and not State.specialMode and not State.bossCompleted then
        if isPlayerAlive() then
            equipTool()
        end
    end
    
    State.shootingEnabled = true
    State.shootingErrors = 0
end

local function initialize()
    if not player.Character then
        player.CharacterAdded:Wait()
    end
    
    player.CharacterAdded:Connect(onCharacterAdded)
    
    onCharacterAdded(player.Character)
    
    task.spawn(farmingLoop)
    
    task.spawn(function()
        while State.isRunning and not State.bossCompleted do
            task.wait(30)
            cache.workspaceChildren = {}
        end
    end)
end

task.spawn(function()
    while not game:IsLoaded() do
        task.wait(0.5)
    end
    
    while not Players.LocalPlayer do
        task.wait(0.5)
    end
    
    player = Players.LocalPlayer
    
    if not player.Character then
        player.CharacterAdded:Wait()
    end
    
    task.wait(2)
    
    local success, err = pcall(initialize)
    if not success then
        task.wait(5)
        pcall(initialize)
    end
end)

return {
    Stop = function()
        State.isRunning = false
        State.shootingEnabled = false
    end,
    
    Start = function()
        if not State.isRunning then
            State.isRunning = true
            State.shootingEnabled = true
            task.spawn(farmingLoop)
        end
    end,
    
    EnableShooting = function()
        State.shootingEnabled = true
        State.shootingErrors = 0
    end,
    
    DisableShooting = function()
        State.shootingEnabled = false
    end,
    
    EquipTool = equipTool,
    
    GetStatus = function()
        return {
            BossSpawned = State.bossHasSpawned,
            BossCompleted = State.bossCompleted,
            CurrentTarget = State.currentTarget and State.currentTarget.Name or "None",
            AutoTeleportTriggered = State.autoTeleportTriggered,
            CurrentPlaceId = game.PlaceId,
            PlayerAlive = State.playerAlive,
            ShootingEnabled = State.shootingEnabled,
            ShootingErrors = State.shootingErrors,
            RewardSpawned = State.rewardPresentSpawned,
            RewardTaken = State.rewardTaken,
            PlatformCreated = State.platformCreated,
            Teleported = State.teleported,
            DungeonAttempts = State.dungeonTeleportAttempts,
            WaitingForReward = State.waitingForReward,
            EnemiesLeft = anyEnemiesLeft()
        }
    end,
    
    TriggerDungeon = function()
        if not State.bossCompleted then
            handleDungeonTeleport()
        end
    end,
    
    ResetShooting = function()
        State.shootingEnabled = true
        State.shootingErrors = 0
        State.lastFireTime = 0
        equipTool()
    end
}
