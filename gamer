repeat task.wait() until game:IsLoaded()
local Players = game:GetService("Players")
repeat task.wait() until Players.LocalPlayer
local player = Players.LocalPlayer

local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")
local TweenService = game:GetService("TweenService")
local TeleportService = game:GetService("TeleportService")

local CONFIG = {
    FIRE_RATE = 0.05,
    TOOL_NAME = "Equinox Cannon",
    REMOTE_NAME = "RemoteFunction"
}

-- Ignored enemies list (these are our allies now)
local IGNORE_ENEMIES = {
    ["Champion of the Equinox"] = true,
    ["Fiscus"] = true,
    ["Shellshock"] = true,
    ["The Last Spirit of Christmas"] = true,
    ["Present Mimic"] = true
}

-- Priority enemies (only Comet boss now)
local PRIORITY_ENEMIES = {
    ["Comet, the Mechanical Vengeance"] = true
}

-- Item to NPC mapping with spawn data
local ITEM_TO_NPC = {
    ["Equinox Seal"] = {
        name = "Champion of the Equinox",
        remoteArg = "Twilight",
        spawnPosition = Vector3.new(-90.90042114257812, 10.091531753540039, 64.10246276855469)
    },
    ["Aromatic Seagrass"] = {
        name = "Shellshock",
        remoteArg = "Shellshock",
        spawnPosition = Vector3.new(-81.57182312011719, 9.976997375488281, 48.956748962402344)
    },
    ["Ominous Dark Egg"] = {
        name = "Fiscus",
        remoteArg = "Fiscus",
        spawnPosition = Vector3.new(-90, 10, 60)  -- Default position for Fiscus
    }
}

-- Place IDs
local SPECIFIC_PLACE_ID = 112802237735950
local AUTOTELEPORT_PLACE_ID = 8811271345

-- Platform position
local PLATFORM_POSITION = Vector3.new(-251, 130, 3783)
local PLATFORM_SIZE = Vector3.new(20, 5, 20)  -- 20x20 platform with 5 studs height

-- State management
local State = {
    isRunning = true,
    specialMode = false,
    lastFireTime = 0,
    currentTarget = nil,
    chargeValue = 100,
    bossHasSpawned = false,
    bossCompleted = false,
    playerAlive = true,
    skipSaid = false,
    skipAllSaid = false,
    teleported = false,
    itemsUsed = {
        ["Equinox Seal"] = false,
        ["Aromatic Seagrass"] = false,
        ["Ominous Dark Egg"] = false
    },
    npcSpawned = {
        ["Champion of the Equinox"] = false,
        ["Shellshock"] = false,
        ["Fiscus"] = false
    },
    rewardCollected = false,
    rewardPresentSpawned = false,
    rewardTaken = false,
    autoTeleportTriggered = false,
    shootingEnabled = true,
    shootingErrors = 0,
    maxShootingErrors = 5,
    platformCreated = false,
    dungeonTeleportAttempts = 0,
    maxDungeonAttempts = 3,
    bossDefeatedTime = 0,
    waitingForReward = false,
    rewardCheckStarted = false
}

local cache = {
    workspaceChildren = {},
    lastWorkspaceUpdate = 0,
    workspaceUpdateInterval = 0.5,
    lastPriorityCheck = 0
}

-- Helper functions
local function chatMessage(str)
    if type(str) ~= "string" then str = tostring(str) end
    
    if TextChatService.ChatVersion == Enum.ChatVersion.LegacyChatService then
        local events = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
        if events then
            local remote = events:FindFirstChild("SayMessageRequest")
            if remote then
                task.spawn(function()
                    pcall(remote.FireServer, remote, str, "All")
                end)
            end
        end
    else
        local channel = TextChatService:FindFirstChild("TextChannels")
        if channel then
            channel = channel:FindFirstChild("RBXGeneral")
            if channel and channel:IsA("TextChannel") then
                task.spawn(function()
                    pcall(channel.SendAsync, channel, str)
                end)
            end
        end
    end
end

local function sendSkipCommands()
    if game.PlaceId ~= SPECIFIC_PLACE_ID then return end
    if State.skipAllSaid then return end
    
    task.spawn(function()
        task.wait(0.5)
        chatMessage("/skipall")
        State.skipAllSaid = true
    end)
end

local function findRemoteFunction()
    -- Try to find the RemoteFunction in different locations
    local locations = {
        player,
        ReplicatedStorage,
        workspace
    }
    
    for _, location in ipairs(locations) do
        local remote = location:FindFirstChild("RemoteFunction")
        if remote and remote:IsA("RemoteFunction") then
            return remote
        end
    end
    
    -- Also check in Remotes folder
    local remotesFolder = ReplicatedStorage:FindFirstChild("Remotes")
    if remotesFolder then
        local remote = remotesFolder:FindFirstChild("RemoteFunction")
        if remote and remote:IsA("RemoteFunction") then
            return remote
        end
    end
    
    return nil
end

local function useItem(itemName)
    local npcData = ITEM_TO_NPC[itemName]
    if not npcData then return false end
    
    local character = player.Character
    local backpack = player:FindFirstChild("Backpack")
    
    if not character or not backpack then return false end
    
    local item = backpack:FindFirstChild(itemName) or character:FindFirstChild(itemName)
    if not item then return false end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return false end
    
    -- Equip the item first
    humanoid:EquipTool(item)
    task.wait(0.5)  -- Wait to ensure tool is properly equipped
    
    -- For all items, try to find and use the proper remote
    local success = false
    
    if itemName == "Equinox Seal" or itemName == "Aromatic Seagrass" then
        -- Try to find the remote function
        local remoteFunction = findRemoteFunction()
        
        if remoteFunction then
            success = pcall(function()
                local torso = character:FindFirstChild("Torso") or character:FindFirstChild("UpperTorso") or character:FindFirstChild("HumanoidRootPart")
                if not torso then return false end
                
                local args = {
                    [1] = npcData.remoteArg,
                    [2] = {
                        [1] = npcData.spawnPosition,
                        [2] = torso
                    }
                }
                
                remoteFunction:InvokeServer(unpack(args))
                return true
            end)
        end
        
        if not success then
            -- Fallback: try to use Activate method
            success = pcall(function()
                item:Activate()
                task.wait(0.1)
                return true
            end)
        end
    else
        -- For Ominous Dark Egg, use Activate
        success = pcall(function()
            item:Activate()
            task.wait(0.1)
            return true
        end)
    end
    
    -- Unequip after use
    task.wait(0.3)
    humanoid:UnequipTools()
    
    return success
end

local function checkNpcSpawned()
    -- Check which NPCs have spawned
    for npcName, _ in pairs(State.npcSpawned) do
        local npc = workspace:FindFirstChild(npcName)
        State.npcSpawned[npcName] = npc ~= nil
    end
end

local function useSpawnItems()
    -- Check which NPCs have spawned BEFORE trying to use items
    checkNpcSpawned()
    
    -- Use items only if corresponding NPC hasn't spawned
    for itemName, npcData in pairs(ITEM_TO_NPC) do
        local npcName = npcData.name
        if not State.npcSpawned[npcName] and not State.itemsUsed[itemName] then
            print("Attempting to use item:", itemName, "to spawn NPC:", npcName)
            local success = useItem(itemName)
            if success then
                State.itemsUsed[itemName] = true
                print("Successfully used item:", itemName)
                task.wait(2)  -- Wait for NPC to spawn
                checkNpcSpawned()  -- Re-check after using item
            else
                print("Failed to use item:", itemName)
                -- Still mark as used so we don't retry
                State.itemsUsed[itemName] = true
            end
        end
    end
end

local function createPlatform()
    if State.platformCreated then return end
    
    local platform = Instance.new("Part")
    platform.Name = "AutoFarmPlatform"
    platform.Size = PLATFORM_SIZE
    platform.Position = PLATFORM_POSITION + Vector3.new(0, PLATFORM_SIZE.Y/2, 0)
    platform.Anchored = true
    platform.CanCollide = true
    platform.Transparency = 0.7
    platform.Color = Color3.fromRGB(0, 170, 255)
    platform.Material = Enum.Material.Neon
    
    local surfaceGui = Instance.new("SurfaceGui", platform)
    surfaceGui.Face = Enum.NormalId.Top
    surfaceGui.AlwaysOnTop = true
    
    local textLabel = Instance.new("TextLabel", surfaceGui)
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = "AutoFarm Platform"
    textLabel.TextColor3 = Color3.new(1, 1, 1)
    textLabel.TextScaled = true
    
    platform.Parent = workspace
    
    State.platformCreated = true
end

local function teleportToPlatform()
    if State.teleported then return end
    
    local char = player.Character
    if not char then return end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    -- Create platform first
    if not State.platformCreated then
        createPlatform()
    end
    
    -- Teleport to platform
    State.teleported = true
    
    local tweenInfo = TweenInfo.new(1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local targetCFrame = CFrame.new(PLATFORM_POSITION + Vector3.new(0, 5, 0))
    local tween = TweenService:Create(hrp, tweenInfo, {CFrame = targetCFrame})
    tween:Play()
end

local function isPlayerAlive()
    if not player.Character then return false end
    
    local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return false end
    
    return humanoid.Health > 0
end

local function checkAutoTeleport()
    if State.autoTeleportTriggered then
        return false
    end
    
    if game.PlaceId == AUTOTELEPORT_PLACE_ID then
        State.autoTeleportTriggered = true
        return true
    end
    
    return false
end

local function getTargetPart(model)
    local enemyName = model.Name
    
    -- Special handling for Comet boss - look for Body meshpart in MainBody
    if enemyName == "Comet, the Mechanical Vengeance" then
        local mainBody = model:FindFirstChild("MainBody")
        if mainBody then
            local bodyPart = mainBody:FindFirstChild("Body")
            if bodyPart and bodyPart:IsA("BasePart") then
                return bodyPart
            end
        end
        
        -- Fallback to Torso if Body not found
        local torso = model:FindFirstChild("Torso")
        if torso then
            return torso
        end
    end
    
    -- Default part search for other enemies
    local possibleParts = {
        "HumanoidRootPart",
        "Head",
        "Torso", 
        "UpperTorso",
        "LowerTorso",
        "Chest",
        "Body"
    }
    
    for _, partName in ipairs(possibleParts) do
        local part = model:FindFirstChild(partName)
        if part and part:IsA("BasePart") then
            return part
        end
    end
    
    for _, child in ipairs(model:GetChildren()) do
        if child:IsA("BasePart") then
            return child
        end
    end
    
    return nil
end

local function findEnemies()
    if not State.playerAlive or not State.shootingEnabled then 
        return {}
    end
    
    local now = tick()
    
    if now - cache.lastWorkspaceUpdate > cache.workspaceUpdateInterval then
        cache.workspaceChildren = workspace:GetChildren()
        cache.lastWorkspaceUpdate = now
    end
    
    local enemies = {}
    local priorityEnemies = {}
    
    for _, model in ipairs(cache.workspaceChildren) do
        if model:IsA("Model") and model.Parent == workspace then
            -- Skip ignored enemies (our allies)
            if IGNORE_ENEMIES[model.Name] then
                continue
            end
            
            local humanoid = model:FindFirstChildOfClass("Humanoid")
            
            if humanoid and humanoid.Health > 0 then
                local isPlayerCharacter = false
                for _, plr in ipairs(Players:GetPlayers()) do
                    if plr.Character == model then
                        isPlayerCharacter = true
                        break
                    end
                end
                
                if not isPlayerCharacter then
                    local targetPart = getTargetPart(model)
                    if targetPart then
                        local enemyData = {
                            Model = model,
                            Humanoid = humanoid,
                            TargetPart = targetPart,
                            Position = targetPart.Position,
                            Name = model.Name,
                            IsPriority = PRIORITY_ENEMIES[model.Name] == true,
                            LastSeen = now
                        }
                        
                        if model.Name == "Comet, the Mechanical Vengeance" then
                            State.bossHasSpawned = true
                        end
                        
                        if enemyData.IsPriority then
                            table.insert(priorityEnemies, enemyData)
                        else
                            table.insert(enemies, enemyData)
                        end
                    end
                end
            end
        end
    end
    
    if #priorityEnemies > 0 then
        return priorityEnemies
    end
    
    return enemies
end

local function selectTarget()
    if not State.playerAlive or not State.shootingEnabled then 
        return nil
    end
    
    local enemies = findEnemies()
    
    if #enemies == 0 then
        return nil
    end
    
    if State.currentTarget then
        local targetModel = State.currentTarget.Model
        if targetModel and targetModel.Parent then
            local humanoid = targetModel:FindFirstChildOfClass("Humanoid")
            if humanoid and humanoid.Health > 0 then
                return State.currentTarget
            end
        end
    end
    
    local character = player.Character
    if not character then 
        return enemies[1] 
    end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then 
        return enemies[1] 
    end
    
    local playerPos = humanoidRootPart.Position
    local closestEnemy = enemies[1]
    local closestDistance = math.huge
    
    for _, enemy in ipairs(enemies) do
        local distance = (enemy.Position - playerPos).Magnitude
        if distance < closestDistance then
            closestDistance = distance
            closestEnemy = enemy
        end
    end
    
    return closestEnemy
end

local function getValidTool()
    if not State.playerAlive or not State.shootingEnabled then 
        return nil 
    end
    
    local character = player.Character
    if not character then 
        return nil 
    end
    
    local tool = character:FindFirstChild(CONFIG.TOOL_NAME)
    if not tool then 
        return nil 
    end
    
    local remote = tool:FindFirstChild(CONFIG.REMOTE_NAME)
    local handle = tool:FindFirstChild("Handle")
    
    if remote and handle and remote:IsA("RemoteFunction") then
        return {Tool = tool, Remote = remote, Handle = handle}
    end
    
    return nil
end

local function equipTool()
    if not State.playerAlive then 
        task.wait(0.5)
        return false
    end
    
    local character = player.Character
    if not character then 
        task.wait(0.5)
        return false
    end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then 
        task.wait(0.5)
        return false
    end
    
    local tool = character:FindFirstChild(CONFIG.TOOL_NAME)
    if tool then
        humanoid:EquipTool(tool)
        return true
    end
    
    local backpack = player:FindFirstChild("Backpack")
    if backpack then
        tool = backpack:FindFirstChild(CONFIG.TOOL_NAME)
        if tool then
            tool.Parent = character
            task.wait(0.1)
            humanoid:EquipTool(tool)
            return true
        end
    end
    
    return false
end

local function equipArcticCore()
    local character = player.Character
    if not character then return false end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return false end
    
    -- Check if Arctic Core is in character
    local arcticCore = character:FindFirstChild("Arctic Core")
    if not arcticCore then
        -- Check backpack
        local backpack = player:FindFirstChild("Backpack")
        if backpack then
            arcticCore = backpack:FindFirstChild("Arctic Core")
            if arcticCore then
                arcticCore.Parent = character
                task.wait(0.2)
            end
        end
    end
    
    if arcticCore then
        humanoid:EquipTool(arcticCore)
        task.wait(0.5)
        return true
    end
    
    return false
end

local function attemptFire()
    if not State.isRunning or State.specialMode then 
        return 
    end
    if not State.playerAlive or not State.shootingEnabled then 
        return 
    end
    
    State.currentTarget = selectTarget()
    if not State.currentTarget then
        return
    end
    
    local toolData = getValidTool()
    if not toolData then 
        local equipped = equipTool()
        if not equipped then 
            return 
        end
        
        toolData = getValidTool()
        if not toolData then 
            return 
        end
    end
    
    local now = tick()
    if now - State.lastFireTime < CONFIG.FIRE_RATE then 
        return 
    end
    
    State.lastFireTime = now
    
    local targetPart = State.currentTarget.TargetPart
    if not targetPart then
        return
    end
    
    local targetPos = targetPart.Position
    
    local camera = workspace.CurrentCamera
    if not camera then 
        return 
    end
    
    local cameraPosition = camera.CFrame.Position
    local direction = (targetPos - cameraPosition).Unit
    
    local startPos = targetPos - (direction * 5)
    local endPos = targetPos
    
    local fireSuccess = pcall(function()
        toolData.Remote:InvokeServer("fire", {startPos, endPos, State.chargeValue})
    end)
    
    if not fireSuccess then
        State.shootingErrors = State.shootingErrors + 1
        
        if State.shootingErrors > State.maxShootingErrors then
            State.shootingEnabled = false
            task.wait(2)
            State.shootingEnabled = true
            State.shootingErrors = 0
        end
    else
        State.shootingErrors = 0
    end
end

local function checkBossStatus()
    local comet = workspace:FindFirstChild("Comet, the Mechanical Vengeance")
    
    if comet then
        State.bossHasSpawned = true
        
        local humanoid = comet:FindFirstChildOfClass("Humanoid")
        if humanoid then
            if humanoid.Health <= 0 then
                return "dead"
            else
                return "alive"
            end
        else
            return "spawning"
        end
    else
        return "not_spawned"
    end
end

local function checkRewardPresent()
    local present = workspace:FindFirstChild("RewardPresent")
    
    if present then
        State.rewardPresentSpawned = true
        
        -- Check if present has been taken (model still exists but might be empty)
        local mesh = present:FindFirstChild("Present")
        if not mesh then
            State.rewardTaken = true
            return "taken"
        end
        
        return "exists"
    else
        if State.rewardPresentSpawned and not State.rewardTaken then
            State.rewardTaken = true
            return "taken"
        end
        return "not_found"
    end
end

local function collectReward()
    local present = workspace:FindFirstChild("RewardPresent")
    if not present then return false end
    
    local mesh = present:FindFirstChild("Present")
    if not mesh then return false end
    
    local char = player.Character
    if not char then return false end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end
    
    -- Teleport to the present
    local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local targetCFrame = CFrame.new(present.Position + Vector3.new(0, 3, 0))
    local tween = TweenService:Create(hrp, tweenInfo, {CFrame = targetCFrame})
    tween:Play()
    
    return true
end

local function createPartyAndJoin()
    -- First create the party
    local createSuccess = pcall(function()
        local args = {
            [1] = "createParty",
            [2] = {
                ["settings"] = {
                    ["Visual"] = true,
                    ["FriendsOnly"] = false,
                    ["TormentMode"] = true
                },
                ["subplace"] = "ArcticZone"
            }
        }
        
        local partyRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("PartySystem"):WaitForChild("PartyFunction")
        partyRemote:InvokeServer(unpack(args))
        return true
    end)
    
    if not createSuccess then
        return false
    end
    
    task.wait(2)
    
    -- Then join the subplace
    local joinSuccess = pcall(function()
        local args = {
            [1] = "joinSubplace",
            [2] = {}
        }
        
        local partyRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("PartySystem"):WaitForChild("PartyFunction")
        partyRemote:InvokeServer(unpack(args))
        return true
    end)
    
    return joinSuccess
end

local function attemptArcticTeleport()
    State.bossCompleted = true
    State.specialMode = true
    State.isRunning = false
    State.shootingEnabled = false
    
    -- Wait after reward taken
    task.wait(5)
    
    -- Unequip cannon
    local tool = getValidTool()
    if tool and tool.Tool then
        tool.Tool.Parent = player.Backpack
    end
    
    task.wait(1)
    
    -- Try to teleport to dungeon
    local success = false
    for attempt = 1, State.maxDungeonAttempts do
        State.dungeonTeleportAttempts = attempt
        
        success = createPartyAndJoin()
        
        if success then
            break
        end
        
        if attempt < State.maxDungeonAttempts then
            task.wait(3)
        end
    end
    
    return success
end

local function handleAutoTeleport()
    -- This handles auto-teleport from AUTOTELEPORT_PLACE_ID
    State.bossCompleted = true
    State.specialMode = true
    State.isRunning = false
    State.shootingEnabled = false
    
    task.wait(2)
    
    -- Equip Arctic Core first
    local equipped = equipArcticCore()
    if not equipped then
        State.bossCompleted = false
        State.specialMode = false
        State.isRunning = true
        State.shootingEnabled = true
        State.autoTeleportTriggered = false
        return
    end
    
    task.wait(1)
    
    -- Create party and join directly
    local success = createPartyAndJoin()
    
    if not success then
        State.bossCompleted = false
        State.specialMode = false
        State.isRunning = true
        State.shootingEnabled = true
        State.autoTeleportTriggered = false
    end
end

local function farmingLoop()
    local lastBossCheck = 0
    local bossCheckInterval = 2
    local lastRewardCheck = 0
    local rewardCheckInterval = 1
    local lastItemCheck = 0
    local itemCheckInterval = 5
    
    while State.isRunning and not State.bossCompleted do
        local now = tick()
        
        State.playerAlive = isPlayerAlive()
        
        if State.playerAlive then
            if checkAutoTeleport() then
                handleAutoTeleport()
                break
            end
            
            -- Periodically check and use spawn items
            if now - lastItemCheck > itemCheckInterval then
                useSpawnItems()
                lastItemCheck = now
            end
            
            if now - lastBossCheck > bossCheckInterval then
                local bossStatus = checkBossStatus()
                
                if State.bossHasSpawned and bossStatus == "dead" and not State.bossCompleted then
                    -- Boss died, start checking for reward
                    State.bossCompleted = true
                    State.bossDefeatedTime = now
                    State.waitingForReward = true
                end
                
                lastBossCheck = now
            end
            
            if State.waitingForReward then
                -- Check for reward present
                if now - lastRewardCheck > rewardCheckInterval then
                    local rewardStatus = checkRewardPresent()
                    
                    if rewardStatus == "exists" and not State.rewardTaken then
                        collectReward()
                    elseif rewardStatus == "taken" then
                        State.waitingForReward = false
                        attemptArcticTeleport()
                        break
                    end
                    
                    lastRewardCheck = now
                end
            else
                -- Normal farming - continue shooting even after boss death if not waiting for reward
                if not State.bossCompleted then
                    attemptFire()
                end
            end
        else
            State.currentTarget = nil
        end
        
        RunService.Heartbeat:Wait()
    end
end

local function onCharacterAdded(character)
    task.wait(2)
    
    if game.PlaceId == SPECIFIC_PLACE_ID then
        -- First use spawn items before teleporting
        if not State.itemsUsed["Equinox Seal"] and 
           not State.itemsUsed["Aromatic Seagrass"] and 
           not State.itemsUsed["Ominous Dark Egg"] then
            task.wait(1)
            useSpawnItems()
            task.wait(1)  -- Wait for NPCs to spawn
        end
        
        -- Send skip command
        if not State.skipAllSaid then
            sendSkipCommands()
        end
        
        -- Teleport to platform after skip command
        task.wait(1)
        if not State.teleported then
            teleportToPlatform()
        end
    end
    
    if State.isRunning and not State.specialMode and not State.bossCompleted then
        if isPlayerAlive() then
            equipTool()
        end
    end
end

local function initialize()
    if not player.Character then
        player.CharacterAdded:Wait()
    end
    
    player.CharacterAdded:Connect(onCharacterAdded)
    
    onCharacterAdded(player.Character)
    
    task.spawn(farmingLoop)
    
    task.spawn(function()
        while State.isRunning and not State.bossCompleted do
            task.wait(30)
            cache.workspaceChildren = {}
        end
    end)
end

task.spawn(function()
    while not game:IsLoaded() do
        task.wait(0.5)
    end
    
    while not Players.LocalPlayer do
        task.wait(0.5)
    end
    
    player = Players.LocalPlayer
    
    if not player.Character then
        player.CharacterAdded:Wait()
    end
    
    task.wait(2)
    
    local success, err = pcall(initialize)
    if not success then
        task.wait(5)
        pcall(initialize)
    end
end)

return {
    Stop = function()
        State.isRunning = false
        State.shootingEnabled = false
    end,
    
    Start = function()
        if not State.isRunning then
            State.isRunning = true
            State.shootingEnabled = true
            task.spawn(farmingLoop)
        end
    end,
    
    EnableShooting = function()
        State.shootingEnabled = true
        State.shootingErrors = 0
    end,
    
    DisableShooting = function()
        State.shootingEnabled = false
    end,
    
    EquipTool = equipTool,
    
    GetStatus = function()
        return {
            BossSpawned = State.bossHasSpawned,
            BossCompleted = State.bossCompleted,
            CurrentTarget = State.currentTarget and State.currentTarget.Name or "None",
            AutoTeleportTriggered = State.autoTeleportTriggered,
            CurrentPlaceId = game.PlaceId,
            PlayerAlive = State.playerAlive,
            ShootingEnabled = State.shootingEnabled,
            ShootingErrors = State.shootingErrors,
            ItemsUsed = State.itemsUsed,
            NPCSpawned = State.npcSpawned,
            RewardSpawned = State.rewardPresentSpawned,
            RewardTaken = State.rewardTaken,
            PlatformCreated = State.platformCreated,
            Teleported = State.teleported,
            DungeonAttempts = State.dungeonTeleportAttempts,
            WaitingForReward = State.waitingForReward
        }
    end,
    
    TriggerDungeon = function()
        if not State.bossCompleted then
            attemptArcticTeleport()
        end
    end,
    
    ResetShooting = function()
        State.shootingEnabled = true
        State.shootingErrors = 0
        State.lastFireTime = 0
        equipTool()
    end,
    
    UseSpawnItems = function()
        useSpawnItems()
    end
}
